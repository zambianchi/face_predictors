import $ from"jquery";import"@fullcalendar/core/vdom";import{Calendar}from"@fullcalendar/core";import dayGridPlugin from"@fullcalendar/daygrid";import interactionPlugin,{Draggable}from"@fullcalendar/interaction";import itLocale from"@fullcalendar/core/locales/it";import moment from"moment";$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf_token"]').attr("content"),Accept:"application/json","Content-Type":"application/json"}});class EventData{constructor(a=0,e,t,l=0,n=0,s=0){this.id=a,this.date=e,this.type=t,this.price=l,this.category_id=n,this.scheduler_id=s,this.meals=[]}addMeal(a){this.meals.push(a)}}var eventToDelete=[],eventToDeleteTemp=null,removeModalElement=null,calendarElement=null,isPostingData=!1;function createCalendar(){var a=document.getElementById("calendar");a&&(calendarElement=new Calendar(a,{plugins:[dayGridPlugin,interactionPlugin],initialView:"dayGridMonth",locale:itLocale,hiddenDays:hiddenDaysCalendar,dayCellClassNames:function(a){festivityDaysCalendar&&festivityDaysCalendar.includes(moment(a.date).format("YYYY-MM-DD"))&&(a.isDisabled=!0)},headerToolbar:{left:"prev,next",center:"title",right:"dayGridMonth,dayGridWeek"},initialDate:moment().format(),validRange:function(a){return{start:currentDateCost,end:moment(currentDateCost).add(14,"days").format()}},events:calendaDataEventsConst,eventClick:function(a){isPostingData||(a.event.title&&$("#dataModalContent").text(a.event.title),eventToDeleteTemp=a.event,(removeModalElement=new Bootstrap.Modal($("#removeDataModal"),{keyboard:!1})).show())},dateClick:function(a){festivityDaysCalendar&&festivityDaysCalendar.includes(a.dateStr)||getAvailableMenu(a.dateStr)}}),renderCalendar())}function createDraggableElements(){}function renderCalendar(){void 0!==calendarElement&&calendarElement.render()}function saveChanges(){var a=getEventByCalendar();if(a||eventToDelete){let e={eventToAdd:a.filter((a=>!a.id)).map((a=>a.extendedProps.eventDataCustom)),eventToDelete:eventToDelete,student:studentIdConst};isPostingData=!0,$.ajax({url:baseUrlConst+"/calendar-changes-save",dataType:"json",contentType:"json",data:JSON.stringify(e),type:"POST",success:function(a){isPostingData=!1,document.location.reload(!0)}})}else document.location.reload(!0)}function getAvailableMenu(a){if(a&&!isPostingData){let e={date:a,student:studentIdConst};isPostingData=!0,$.ajax({url:baseUrlConst+"/calendar-available-menu",dataType:"json",contentType:"json",data:JSON.stringify(e),type:"POST",success:function(e){if(isPostingData=!1,e&&e.isSuccess&&($("#availableDataContainer").empty(),e.availableData)){if(e.availableData.menus&&0!=e.availableData.menus.length){var t=getCalendarEventByDate(a);if(e.availableData.scheduler_type>=1&&e.availableData.scheduler_type<=3)if(t&&t.length>0)$("#availableDataContainer").append('<tr><td colspan="5">Risulta già presente una prenotazione per la giornata</td></tr>');else switch(e.availableData.scheduler_type){case 1:case 2:$("#availableDataContainer").append(createElementsMenu1and2(a,e.availableData.menus));break;case 3:$("#availableDataContainer").append(createElementsMenu3(a,e.availableData.menus))}else if(4==e.availableData.scheduler_type)for(var l=0;l<e.availableData.menus.length;l++)if(e.availableData.menus[l].mealCateories)for(var n=0;n<e.availableData.menus[l].mealCateories.length;n++)if($("#availableDataContainer").append('<tr><th colspan="4">'+e.availableData.menus[l].mealCateories[n].description+"</th></tr>"),t){let i=t.find((a=>a.extendedProps.meal&&a.extendedProps.meal.category_id==e.availableData.menus[l].mealCateories[n].id||a.extendedProps.eventDataCustom&&a.extendedProps.eventDataCustom.category_id==e.availableData.menus[l].mealCateories[n].id));if(i)$("#availableDataContainer").append('<tr><td colspan="5">Risulta già presente un piatto di questa categoria per la giornata</td></tr>');else for(var s=0;s<e.availableData.menus[l].mealCateories[n].meals.length;s++){var d='<tr><td class="text-start text-truncate"><div><div class="d-sm-flex flex-row flex-wrap align-items-center">';e.availableData.menus[l].mealCateories[n].meals[s].image_path&&(d+='<span class="thumb-lg me-sm-3 ms-md-0 me-xl-3 d-none d-md-inline-block"><img src="'+e.availableData.menus[l].mealCateories[n].meals[s].image_path+'" class="bg-light"></span>'),d+='<div class="mt-2 mt-sm-0 mt-md-2 mt-xl-0"><p class="mb-0">'+e.availableData.menus[l].mealCateories[n].meals[s].name+'</p><small class="text-muted">'+e.availableData.menus[l].mealCateories[n].meals[s].description+'</small></div></div></div></td><td class="text-start text-truncate">'+e.availableData.menus[l].mealCateories[n].meals[s].weight+' g.</td><td class="text-start text-truncate">'+e.availableData.menus[l].mealCateories[n].meals[s].price+" €</td>",e.availableData.menus[l].mealCateories[n].meals[s].intolerance?d+='<td class="text-start text-truncate">'+e.availableData.menus[l].mealCateories[n].meals[s].intolerance+"</td>":d+="<td></td>",d+='<td class="text-center" style="min-width:100px;"><div><div class="form-group mb-0"><button class="btn btn-primary btn-block btn-sm btn-add-meal" data-id="'+e.availableData.menus[l].mealCateories[n].meals[s].id+'"data-price="'+e.availableData.menus[l].mealCateories[n].meals[s].price+'"data-name="'+e.availableData.menus[l].mealCateories[n].meals[s].name+'"data-category_id="'+e.availableData.menus[l].mealCateories[n].id+'"data-scheduler_id="'+e.availableData.menus[l].schedulerId+'"data-date="'+a+'"data-bs-dismiss="modal">Aggiungi</button></div></div></td></tr>',$("#availableDataContainer").append(d)}}}else $("#availableDataContainer").append("<tr><td>Nessuna portata disponibile per la data richiesta</td></tr>");new Bootstrap.Modal($("#infoAvailableDataModal"),{keyboard:!1}).show()}}})}}function createElementsMenu1and2(a,e){if(e){for(var t="",l=0;l<e.length;l++)if(t+='<tr class="table-primary"><td class="text-start fw-bold text-truncate"><div><div class="d-sm-flex flex-row flex-wrap align-items-center"><div class="mt-2 mt-sm-0 mt-md-2 mt-xl-0"><p class="mb-0">'+e[l].name+'</p><small class="text-muted">'+e[l].description+'</small></div></div></div></td><td class="text-start fw-bold text-truncate">'+e[l].code+'</td><td class="text-start fw-bold text-truncate">'+e[l].price+' €</td><th class="text-center" style="min-width:100px;"><div><div class="form-group mb-0"><button class="btn btn-primary btn-block btn-sm btn-add-menu" data-id="'+e[l].id+'"data-price="'+e[l].price+'"data-name="'+e[l].name+'"data-scheduler_id="'+e[l].schedulerId+'"data-date="'+a+'"data-bs-dismiss="modal">Aggiungi</button></div></div></th></tr>',e[l].mealCateories.length>0)for(var n=0;n<e[l].mealCateories.length;n++)if(t+='<tr class="table-secondary fst-italic text-center"><td colspan="4">'+e[l].mealCateories[n].description,e[l].mealCateories[n].meals)for(var s=0;s<e[l].mealCateories[n].meals.length;s++)t+='<tr><td class="text-start text-truncate" colspan="2"><div><div class="d-sm-flex flex-row flex-wrap align-items-center">',e[l].mealCateories[n].meals[s].image_path&&(t+='<span class="thumb-lg me-sm-3 ms-md-0 me-xl-3 d-none d-md-inline-block"><img src="'+e[l].mealCateories[n].meals[s].image_path+'" class="bg-light"></span>'),t+='<div class="mt-2 mt-sm-0 mt-md-2 mt-xl-0"><p class="mb-0">'+e[l].mealCateories[n].meals[s].name+'</p><small class="text-muted">'+e[l].mealCateories[n].meals[s].description+'</small></div></div></div></td><td class="text-start text-truncate">'+(e[l].mealCateories[n].meals[s].weight>0?e[l].mealCateories[n].meals[s].weight+" g.":"")+"</td>",e[l].mealCateories[n].meals[s].intolerance?t+='<td class="text-start text-truncate">'+e[l].mealCateories[n].meals[s].intolerance+"</td>":t+="<td></td>",t+="</tr>";return t}}function createElementsMenu3(a,e){if(e){for(var t="",l=0;l<e.length;l++)if(t+='<tr class="table-primary"><td class="text-start fw-bold text-truncate"><div><div class="d-sm-flex flex-row flex-wrap align-items-center"><div class="mt-2 mt-sm-0 mt-md-2 mt-xl-0"><p class="mb-0">'+e[l].name+'</p><small class="text-muted">'+e[l].description+'</small></div></div></div></td><td class="text-start fw-bold text-truncate">'+e[l].code+'</td><td class="text-start fw-bold text-truncate">'+e[l].price+' €</td><th class="text-center " style="min-width:100px;"><div><div class="form-group mb-0 d-grid gap-1"><button class="btn btn-secondary btn-block btn-sm btn-compile-menu" data-id="'+e[l].id+'"data-price="'+e[l].price+'"data-name="'+e[l].name+'"data-scheduler_id="'+e[l].schedulerId+'"data-date="'+a+'"data-bs-dismiss="modal">Modifica</button><button class="btn btn-primary btn-block btn-sm btn-confirm-menu" data-id="'+e[l].id+'"data-price="'+e[l].price+'"data-name="'+e[l].name+'"data-scheduler_id="'+e[l].schedulerId+'"data-date="'+a+'"data-bs-dismiss="modal">Conferma</button></div></div></th></tr>',e[l].mealCateories&&e[l].mealCateories.length>0)for(var n=0;n<e[l].mealCateories.length;n++)if(t+='<tr class="table-secondary fst-italic text-center"><td colspan="4">'+e[l].mealCateories[n].description,e[l].mealCateories[n].meals)for(var s=0;s<e[l].mealCateories[n].meals.length&&s<1;s++)t+='<tr><td class="text-start text-truncate" colspan="2"><div><div class="d-sm-flex flex-row flex-wrap align-items-center">',e[l].mealCateories[n].meals[s].image_path&&(t+='<span class="thumb-lg me-sm-3 ms-md-0 me-xl-3 d-none d-md-inline-block"><img src="'+e[l].mealCateories[n].meals[s].image_path+'" class="bg-light"></span>'),t+='<div class="mt-2 mt-sm-0 mt-md-2 mt-xl-0"><p class="mb-0">'+e[l].mealCateories[n].meals[s].name+'</p><small class="text-muted">'+e[l].mealCateories[n].meals[s].description+'</small></div></div></div></td><td class="text-start text-truncate">'+(e[l].mealCateories[n].meals[s].weight>0?e[l].mealCateories[n].meals[s].weight+" g.":"")+"</td>",e[l].mealCateories[n].meals[s].intolerance?t+='<td class="text-start text-truncate">'+data.availableData.menus[l].mealCateories[n].meals[s].intolerance+"</td>":t+="<td></td>",t+="</tr>";return t}}function getEventByCalendar(){return void 0!==calendarElement?calendarElement.getEvents():null}function getCalendarEventByDate(a){if(void 0!==calendarElement){let e=calendarElement.getEvents();if(e)return e.filter((e=>e.startStr==a))}return null}$(document).ready((function(){createCalendar(),createDraggableElements()})),$("#deleteElementButton").click((function(){if(eventToDeleteTemp){if(eventToDeleteTemp.id){let a=new EventData(Number(eventToDeleteTemp.id),eventToDeleteTemp.startStr,null!=eventToDeleteTemp.extendedProps.meal?1:2,Number(eventToDeleteTemp.extendedProps.price));eventToDelete.push(a)}eventToDeleteTemp.remove()}eventToDeleteTemp=null,removeModalElement&&(removeModalElement.hide(),removeModalElement=null)})),$("#availableDataContainer").on("click",".btn-add-menu",(function(a){if(a.target.dataset){let e=new EventData(Number(a.target.dataset.id),a.target.dataset.date,2,Number(a.target.dataset.price),0,Number(a.target.dataset.scheduler_id));void 0!==calendarElement&&calendarElement.addEvent({title:a.target.dataset.name,start:a.target.dataset.date,allDay:!0,eventDataCustom:e})}})),$("#availableDataContainer").on("click",".btn-compile-menu",(function(a){if(a.target.dataset){let e={date:a.target.dataset.date,student:studentIdConst,menu_id:a.target.dataset.id};$.ajax({url:baseUrlConst+"/calendar-available-menu-modular",dataType:"json",contentType:"json",data:JSON.stringify(e),type:"POST",success:function(e){if(e&&e.isSuccess)if($("#availableMealModularDataContainer").empty(),e.availableData&&0!=e.availableData.length){$("#confermaSceltaPortate").prop("disabled",!1);for(var t=getCalendarEventByDate(a.target.dataset.date),l=0;l<e.availableData.length;l++)if($("#availableMealModularDataContainer").append('<tr><th colspan="3">'+e.availableData[l].description+"</th><td>Selezione</td></tr>"),t){let d=t.find((a=>a.extendedProps.meal&&a.extendedProps.meal.category_id==e.availableData[l].id||a.extendedProps.eventDataCustom&&a.extendedProps.eventDataCustom.category_id==e.availableData[l].id));if(d)$("#availableMealModularDataContainer").append('<tr><td colspan="4">Risulta già presente un piatto di questa categoria per la giornata</td></tr>');else for(var n=0;n<e.availableData[l].meals.length;n++){var s='<tr><td class="text-start text-truncate"><div><div class="d-sm-flex flex-row flex-wrap align-items-center">';e.availableData[l].meals[n].image_path&&(s+='<span class="thumb-lg me-sm-3 ms-md-0 me-xl-3 d-none d-md-inline-block"><img src="'+e.availableData[l].meals[n].image_path+'" class="bg-light"></span>'),s+='<div class="mt-2 mt-sm-0 mt-md-2 mt-xl-0"><p class="mb-0">'+e.availableData[l].meals[n].name+'</p><small class="text-muted">'+e.availableData[l].meals[n].description+'</small></div></div></div></td><td colspan="2" class="text-start text-truncate">'+(e.availableData[l].meals[n].weight>0?e.availableData[l].meals[n].weight+" g.":"")+"</td>",e.availableData[l].meals[n].intolerance?s+='<td class="text-start text-truncate">'+e.availableData[l].meals[n].intolerance+"</td>":s+="<td></td>",s+='<td class="text-center" style="min-width:100px;"><div><div class="form-group mb-0"><div class="form-check"><input class="form-check-input" type="radio" name="menuCategoryModularRadio_'+e.availableData[l].id+'" id="menuCategory_'+e.availableData[l].id+'" data-id="'+e.availableData[l].meals[n].id+'"data-price="'+e.availableData[l].meals[n].price+'"data-name="'+e.availableData[l].meals[n].name+'"data-category_id="'+e.availableData[l].id+'"data-menu_id="'+a.target.dataset.id+'"data-menu_name="'+a.target.dataset.name+'"data-scheduler_id="'+a.target.dataset.scheduler_id+'"data-date="'+a.target.dataset.date+'"',1==n&&(s+=" checked"),s+=">",$("#availableMealModularDataContainer").append(s)}}}else $("#availableMealModularDataContainer").append('<tr><th colspan="4">Nessun piatto disponibile</th></tr>'),$("#confermaSceltaPortate").prop("disabled",!0)}}),new Bootstrap.Modal($("#infoAvailableMealsModularModal"),{keyboard:!1}).show()}})),$("#availableDataContainer").on("click",".btn-confirm-menu",(function(a){if(a.target.dataset){let e={date:a.target.dataset.date,student:studentIdConst,menu_id:a.target.dataset.id};$.ajax({url:baseUrlConst+"/calendar-available-menu-modular",dataType:"json",contentType:"json",data:JSON.stringify(e),type:"POST",success:function(e){if(e&&e.isSuccess&&e.availableData&&e.availableData.length>0){let s=new EventData;s.type=3,s.id=Number(a.target.dataset.id),s.scheduler_id=Number(a.target.dataset.scheduler_id),s.date=a.target.dataset.date,s.name=a.target.dataset.name;for(var t=getCalendarEventByDate(a.target.dataset.date),l=0;l<e.availableData.length;l++)if(t){let a=t.find((a=>a.extendedProps.meal&&a.extendedProps.meal.category_id==e.availableData[l].id||a.extendedProps.eventDataCustom&&a.extendedProps.eventDataCustom.category_id==e.availableData[l].id));if(!a)for(var n=1;n<e.availableData[l].meals.length&&n<2;n++)s.addMeal({id:e.availableData[l].meals[n].id,category_id:e.availableData[l].id})}s.meals.length>0&&void 0!==calendarElement&&calendarElement.addEvent({title:s.name,start:s.date,allDay:!0,eventDataCustom:s})}}})}})),$("#availableDataContainer").on("click",".btn-add-meal",(function(a){if(a.target.dataset){let e=new EventData(Number(a.target.dataset.id),a.target.dataset.date,1,Number(a.target.dataset.price),Number(a.target.dataset.category_id),Number(a.target.dataset.scheduler_id));void 0!==calendarElement&&calendarElement.addEvent({title:a.target.dataset.name,start:a.target.dataset.date,allDay:!0,eventDataCustom:e})}})),$("#confermaSceltaPortate").click((function(){var a=$("input[name^='menuCategoryModularRadio_']:checked");if(a){let t=new EventData;t.type=3;for(var e=0;e<a.length;e++)if(a[e].dataset.id>0){t.id=Number(a[e].dataset.menu_id),t.scheduler_id=Number(a[e].dataset.scheduler_id),t.date=a[e].dataset.date,t.name=a[e].dataset.menu_name;let l=getCalendarEventByDate(t.date);if(l){l.find((a=>a.extendedProps.category_id==t.category_id||a.extendedProps.meal&&a.extendedProps.meal.category_id==t.category_id))||t.addMeal({id:a[e].dataset.id,category_id:a[e].dataset.category_id})}}t.meals.length>0&&void 0!==calendarElement&&calendarElement.addEvent({title:t.name,start:t.date,allDay:!0,eventDataCustom:t})}})),$("#salvaOrdini").click((function(){saveChanges()}));
